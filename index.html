<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Maker (v7.3 - Type Restored)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Paper Effect */
        .invoice-preview {
            background: white;
            padding: 40px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            min-height: 800px;
            color: #333;
        }
        
        /* Controls Panel */
        .controls { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* Helpers */
        .quick-date-btn { font-size: 0.7rem; padding: 2px 6px; margin-right: 2px; margin-bottom: 2px; }
        .hover-bg:hover { background-color: #f8f9fa; }
        
        /* Hide spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        
        /* Print Rules */
        @media print {
            .no-print { display: none !important; }
            .invoice-preview { box-shadow: none; padding: 0; margin: 0; width: 100%; }
            body { background: white; }
            .container { max-width: 100% !important; width: 100%; padding: 0; margin: 0; }
            .qr-code-box { break-inside: avoid; }
        }
        
        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" class="container py-4" v-cloak>
    <div class="row">
        
        <div class="col-md-4 no-print">
            
            <div class="controls mb-3 border-top border-warning border-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="m-0">游늭 History</h5>
                    <small class="text-muted">{{ savedInvoices.length }} items</small>
                </div>
                
                <div style="max-height: 150px; overflow-y: auto;" class="mb-2">
                    <div v-for="(inv, index) in savedInvoices" :key="index" class="d-flex justify-content-between align-items-center border-bottom py-1 px-1 hover-bg">
                        <div @click="loadInvoice(index)" style="cursor: pointer; flex-grow: 1;">
                            <div class="fw-bold small"># {{ inv.number }}</div>
                            <div class="text-muted" style="font-size: 0.75rem;">{{ inv.clientName }}</div>
                        </div>
                        <button @click="deleteInvoice(index)" class="btn btn-sm text-danger py-0">칑</button>
                    </div>
                </div>
                <button @click="saveInvoiceToHistory" class="btn btn-warning btn-sm w-100">游 Save Current Invoice</button>
            </div>

            <div class="controls mb-3">
                <h5 class="mb-3">Settings</h5>
                
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="vatSwitch" v-model="isVatPayer">
                    <label class="form-check-label fw-bold small" for="vatSwitch">VAT Payer (Pl치tce DPH)</label>
                </div>

                <label class="small text-muted">Document Type</label>
                <select v-model="docType" class="form-select form-select-sm mb-2">
                    <option value="Faktura">Faktura</option>
                    <option value="Faktura - Da켿ov칳 doklad" v-if="isVatPayer">Faktura - Da켿ov칳 doklad</option>
                    <option value="Z치lohov치 faktura">Z치lohov치 faktura (Proforma)</option>
                </select>

                <label class="small text-muted">Invoice Number</label>
                <div class="input-group input-group-sm mb-2">
                    <span class="input-group-text">#</span>
                    <input type="text" v-model="invoiceNumber" class="form-control">
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="small text-muted">Issue Date</label>
                        <input type="date" v-model="dates.issued" class="form-control form-control-sm">
                    </div>
                    <div class="col-6">
                        <label class="small text-muted">Due Date</label>
                        <input type="date" v-model="dates.due" class="form-control form-control-sm">
                    </div>
                </div>
                <div class="mb-2 text-end">
                    <button class="btn btn-outline-secondary quick-date-btn" @click="addDays(3)">+3</button>
                    <button class="btn btn-outline-secondary quick-date-btn" @click="addDays(7)">+7</button>
                    <button class="btn btn-outline-secondary quick-date-btn" @click="addDays(14)">+14</button>
                    <button class="btn btn-outline-secondary quick-date-btn" @click="addDays(30)">+30</button>
                </div>
            </div>

            <div class="controls mb-3">
                <h5 class="mb-2">Supplier (You)</h5>
                <div class="input-group input-group-sm mb-1">
                    <input type="text" v-model="supplier.ico" placeholder="ICO" class="form-control">
                    <button @click="fetchAres('supplier')" class="btn btn-outline-primary">ARES</button>
                </div>
                <textarea v-model="supplier.details" rows="2" class="form-control form-control-sm mb-2" placeholder="Details..."></textarea>
                <div class="bg-light p-2 rounded border mb-3">
                    <input type="text" v-model="supplier.iban" placeholder="IBAN" class="form-control form-control-sm mb-1">
                    <input type="text" v-model="supplier.swift" placeholder="SWIFT" class="form-control form-control-sm">
                </div>

                <h5 class="mb-2">Client</h5>
                <div class="input-group input-group-sm mb-1">
                    <input type="text" v-model="customer.ico" placeholder="Client ICO" class="form-control">
                    <button @click="fetchAres('customer')" class="btn btn-outline-primary">ARES</button>
                </div>
                <textarea v-model="customer.details" rows="2" class="form-control form-control-sm" placeholder="Client details..."></textarea>
            </div>

            <div class="controls">
                <h5 class="mb-2">Items</h5>
                <div v-for="(item, index) in items" :key="index" class="border-bottom pb-3 mb-2">
                    <div class="d-flex mb-1">
                        <input v-model="item.name" class="form-control form-control-sm me-1" placeholder="Item Name">
                        <button @click="removeItem(index)" class="btn btn-sm btn-outline-danger">칑</button>
                    </div>
                    <div class="row g-1">
                        <div class="col-3">
                            <label class="small text-muted" style="font-size: 10px;">Qty</label>
                            <input type="number" v-model.number="item.qty" class="form-control form-control-sm">
                        </div>
                        <div class="col-3">
                            <label class="small text-muted" style="font-size: 10px;">Price</label>
                            <input type="number" v-model.number="item.price" class="form-control form-control-sm">
                        </div>
                        
                        <div class="col-4">
                            <label class="small text-muted" style="font-size: 10px;">Discount</label>
                            <div class="input-group input-group-sm">
                                <input type="number" v-model.number="item.discountVal" class="form-control text-danger" placeholder="0">
                                <select v-model="item.discountType" class="form-select bg-light" style="max-width: 75px;">
                                    <option value="percent">%</option>
                                    <option value="fixed">K캜</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-2" v-if="isVatPayer">
                            <label class="small text-muted" style="font-size: 10px;">VAT</label>
                            <select v-model.number="item.vat" class="form-select form-select-sm px-1">
                                <option value="0">0</option>
                                <option value="12">12</option>
                                <option value="21">21</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button @click="addItem" class="btn btn-sm btn-success w-100 mt-2">+ Add Item</button>
                
                <div class="mt-3 border-top pt-2">
                    <label class="small fw-bold">Global Discount (K캜)</label>
                    <input type="number" v-model.number="globalDiscount" class="form-control form-control-sm" placeholder="0">
                </div>
            </div>

            <button onclick="window.print()" class="btn btn-primary w-100 mt-4 fw-bold">游둳 PRINT / PDF</button>
            <div class="mt-4 text-center"><button @click="hardReset" class="btn btn-link text-danger btn-sm" style="font-size: 10px;">Reset App</button></div>
        </div>

        <div class="col-md-8">
            <div class="invoice-preview">
                <div class="d-flex justify-content-between align-items-start mb-5">
                    <h1 class="display-6 fw-bold">{{ docType }}</h1>
                    <div class="text-end">
                        <h3 class="fw-light">캛칤slo: <b>{{ invoiceNumber }}</b></h3>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-6">
                        <h6 class="text-uppercase text-muted small fw-bold mb-2">Dodavatel</h6>
                        <div style="white-space: pre-wrap; font-size: 1.1rem;">{{ supplier.details }}</div>
                        <div v-if="!isVatPayer" class="mt-2 fst-italic text-muted small">Nejsem pl치tce DPH</div>
                        <div v-if="supplier.iban" class="mt-3 p-2 bg-light rounded small">
                            <div>IBAN: <b>{{ supplier.iban }}</b></div>
                            <div v-if="supplier.swift">SWIFT: {{ supplier.swift }}</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <h6 class="text-uppercase text-muted small fw-bold mb-2">Odb캩ratel</h6>
                        <div style="white-space: pre-wrap; font-size: 1.1rem;">{{ customer.details }}</div>
                    </div>
                </div>

                <div class="row border-top border-bottom py-3 mb-4">
                    <div class="col-4">
                        <div class="small text-muted text-uppercase">Datum vystaven칤</div>
                        <div class="fw-bold fs-5">{{ formatDate(dates.issued) }}</div>
                    </div>
                    <div class="col-4">
                        <div class="small text-muted text-uppercase">Datum splatnosti</div>
                        <div class="fw-bold fs-5">{{ formatDate(dates.due) }}</div>
                    </div>
                    <div class="col-4">
                        <div class="small text-muted text-uppercase">Forma 칰hrady</div>
                        <div class="fw-bold fs-5">P콏evodem</div>
                    </div>
                    <div class="col-12 mt-2" v-if="isVatPayer">
                        <small class="text-muted">DUZP: {{ formatDate(dates.issued) }}</small>
                    </div>
                </div>

                <table class="table table-hover align-middle mb-4">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" class="border-0 ps-3">Polo쬶a</th>
                            <th scope="col" class="text-end border-0">Mno쬽tv칤</th>
                            <th scope="col" class="text-end border-0">Cena/j.</th>
                            <th scope="col" class="text-end border-0" v-if="hasItemDiscounts">Sleva</th>
                            <th scope="col" class="text-end border-0" v-if="isVatPayer">DPH</th>
                            <th scope="col" class="text-end border-0 pe-3">Celkem</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="item in items">
                            <td class="ps-3 fw-500">{{ item.name }}</td>
                            <td class="text-end text-muted">{{ item.qty }} ks</td>
                            <td class="text-end">{{ formatMoney(item.price) }}</td>
                            <td class="text-end text-danger" v-if="hasItemDiscounts">
                                <span v-if="item.discountVal > 0">
                                    -{{ item.discountVal }}{{ item.discountType === 'percent' ? '%' : ' K캜' }}
                                </span>
                                <span v-else class="text-muted">-</span>
                            </td>
                            <td class="text-end text-muted" v-if="isVatPayer">{{ item.vat }}%</td>
                            <td class="text-end fw-bold pe-3">
                                {{ formatMoney(calcLineTotal(item)) }}
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div class="row">
                    <div class="col-6"></div>
                    <div class="col-6">
                        <table class="table table-sm table-borderless">
                            <tr v-if="globalDiscount > 0">
                                <td class="text-muted">Mezisou캜et:</td>
                                <td class="text-end">{{ formatMoney(totals.subtotal) }}</td>
                            </tr>
                            <tr v-if="globalDiscount > 0">
                                <td class="text-danger">Celkov치 sleva:</td>
                                <td class="text-end text-danger">- {{ formatMoney(globalDiscount) }}</td>
                            </tr>
                            
                            <template v-if="isVatPayer">
                                <tr>
                                    <td class="text-muted">DPH celkem:</td>
                                    <td class="text-end">{{ formatMoney(totals.vatTotal) }}</td>
                                </tr>
                                <tr class="border-top border-dark fs-4 fw-bold">
                                    <td class="pt-3">Celkem s DPH:</td>
                                    <td class="text-end pt-3">{{ formatMoney(totals.total) }}</td>
                                </tr>
                            </template>
                            <template v-else>
                                <tr class="border-top border-dark fs-4 fw-bold">
                                    <td class="pt-3">Celkem k 칰hrad캩:</td>
                                    <td class="text-end pt-3">{{ formatMoney(totals.total) }}</td>
                                </tr>
                            </template>
                        </table>
                    </div>
                </div>

                <div class="qr-code-box mt-4 d-flex align-items-center justify-content-end" v-if="supplier.iban && totals.total > 0">
                    <div class="me-3 text-end text-muted small lh-1">
                        <div>QR Platba</div>
                        <div>Skenovat v bankovnictv칤</div>
                    </div>
                    <div class="border p-2 bg-white rounded">
                        <canvas id="qrCanvas"></canvas>
                    </div>
                </div>

                <div class="mt-5 pt-4 border-top text-center text-muted small">
                    Faktura vystavena elektronicky.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                isVatPayer: false,
                docType: 'Faktura', // Default
                invoiceNumber: new Date().getFullYear() + '001',
                dates: { issued: new Date().toISOString().split('T')[0], due: '' },
                supplier: { ico: '', details: '', iban: '', swift: '' },
                customer: { ico: '', details: '' },
                items: [{ name: 'Slu쬭a', qty: 1, price: 1000, discountVal: 0, discountType: 'percent', vat: 0 }],
                globalDiscount: 0,
                savedInvoices: []
            }
        },
        mounted() {
            this.addDays(14);
            try {
                const get = (k) => { const v = localStorage.getItem(k); return v ? JSON.parse(v) : null; };
                this.savedInvoices = get('app_invoices_v7') || [];
                
                const sup = get('app_supplier_v7');
                if(sup) this.supplier = sup;
                
                const vat = localStorage.getItem('app_vat_v7');
                if(vat !== null) this.isVatPayer = (vat === 'true');
            } catch(e) { console.error(e); }
        },
        computed: {
            hasItemDiscounts() {
                return this.items.some(i => i.discountVal > 0);
            },
            totals() {
                let subtotal = 0;
                let vatTotal = 0;

                this.items.forEach(item => {
                    const lineTotal = this.calcLineTotal(item);
                    subtotal += lineTotal;
                    if (this.isVatPayer) {
                        vatTotal += lineTotal * (item.vat / 100);
                    }
                });

                let total;
                if (this.isVatPayer) {
                    total = subtotal + vatTotal - this.globalDiscount;
                } else {
                    total = subtotal - this.globalDiscount;
                    vatTotal = 0;
                }
                
                return {
                    subtotal: subtotal,
                    vatTotal: vatTotal,
                    total: total > 0 ? total : 0
                };
            },
            qrCodeData() {
                if (!this.supplier.iban || this.totals.total <= 0) return null;
                const am = this.totals.total.toFixed(2);
                let s = `SPD*1.0*ACC:${this.supplier.iban}`;
                if(this.supplier.swift) s += `+${this.supplier.swift}`;
                s += `*AM:${am}*CC:CZK*MSG:FA ${this.invoiceNumber}`;
                return s;
            }
        },
        watch: {
            qrCodeData: { immediate: true, handler(v) { if(v) this.$nextTick(() => this.genQR(v)); } },
            supplier: { handler(v) { localStorage.setItem('app_supplier_v7', JSON.stringify(v)); }, deep: true },
            isVatPayer(v) { 
                localStorage.setItem('app_vat_v7', v); 
                this.items.forEach(i=>i.vat=v?21:0);
                // Only auto-switch if current type is generic. Don't force if user selected Zalohova.
                if(v && this.docType === 'Faktura') this.docType = 'Faktura - Da켿ov칳 doklad';
                if(!v && this.docType === 'Faktura - Da켿ov칳 doklad') this.docType = 'Faktura';
            }
        },
        methods: {
            addDays(d) { 
                if(!this.dates.issued) return;
                const date = new Date(this.dates.issued); date.setDate(date.getDate()+d);
                this.dates.due = date.toISOString().split('T')[0];
            },
            addItem() { 
                this.items.push({ name: '', qty: 1, price: 0, discountVal: 0, discountType: 'percent', vat: this.isVatPayer?21:0 }); 
            },
            removeItem(i) { this.items.splice(i, 1); },
            
            calcLineTotal(item) {
                let unitPrice = item.price;
                if(item.discountVal > 0) {
                    if(item.discountType === 'percent') {
                        unitPrice = unitPrice * (1 - item.discountVal/100);
                    } else {
                        unitPrice = unitPrice - item.discountVal;
                    }
                }
                unitPrice = Math.max(0, unitPrice);
                return item.qty * unitPrice;
            },

            formatMoney(v) { return new Intl.NumberFormat('cs-CZ', { style: 'currency', currency: 'CZK', minimumFractionDigits: 0 }).format(v); },
            formatDate(d) { if(!d) return ''; const [y,m,day] = d.split('-'); return `${day}.${m}.${y}`; },
            
            async fetchAres(t) {
                const ico = t==='supplier'?this.supplier.ico:this.customer.ico;
                try {
                    const r = await fetch(`https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty/${ico}`);
                    if(!r.ok) throw new Error();
                    const d = await r.json();
                    const txt = `${d.obchodniJmeno}\n${d.sidlo.textovaAdresa}\nI캛: ${ico}` + (d.dic ? `\nDI캛: ${d.dic}` : '');
                    if(t==='supplier') this.supplier.details = txt; else this.customer.details = txt;
                } catch(e) { alert('ARES Error (CORS or ID). Enter manually.'); }
            },
            
            saveInvoiceToHistory() {
                 const snap = { number: this.invoiceNumber, clientName: this.customer.details.split('\n')[0], date: this.dates.issued, fullData: JSON.parse(JSON.stringify({
                     docType: this.docType, // Save Doc Type!
                     invoiceNumber: this.invoiceNumber, dates: this.dates, customer: this.customer, items: this.items, globalDiscount: this.globalDiscount
                 }))};
                 
                 const idx = this.savedInvoices.findIndex(i => i.number === this.invoiceNumber);
                 if(idx >= 0) { if(confirm('Overwrite?')) this.savedInvoices[idx] = snap; } 
                 else this.savedInvoices.unshift(snap);
                 
                 localStorage.setItem('app_invoices_v7', JSON.stringify(this.savedInvoices));
            },
            loadInvoice(i) {
                const d = this.savedInvoices[i].fullData;
                Object.assign(this, d);
                if(!this.items[0].discountType) this.items.forEach(it => { it.discountType = 'percent'; it.discountVal = 0; });
            },
            deleteInvoice(i) { this.savedInvoices.splice(i,1); localStorage.setItem('app_invoices_v7', JSON.stringify(this.savedInvoices)); },
            hardReset() { localStorage.clear(); location.reload(); },
            genQR(v) { if(typeof QRious !== 'undefined') new QRious({ element: document.getElementById('qrCanvas'), value: v, size: 100 }); }
        }
    }).mount('#app');
</script>
</body>
</html>
